/*SMS*//*when who why modified*/#include <telephony/ril.h>#include <stdio.h>#include <assert.h>#include <string.h>#include <errno.h>#include <unistd.h>#include <sys/types.h>#include <sys/stat.h>#include <fcntl.h>#include <pthread.h>#include <alloca.h>#include "atchannel.h"#include "at_tok.h"#include "misc.h"#include <getopt.h>#include <sys/socket.h>#include <cutils/sockets.h>#include <cutils/properties.h>#include <termios.h>#include "ril_common.h"#include "sms.h"#define LOG_TAG "RIL"#include <utils/Log.h>/*added by zte-yuang  for adding sms_send_report begin */SMS_Type sms_type =  SMS_GENERAL;/*added by zte-yuang  for adding sms_send_report end *//* request functions **/void requestSendSMS(void *data, size_t datalen, RIL_Token t){	int err;	const char *smsc;	const char *pdu;	int tpLayerLength;	char *cmd1, *cmd2;	RIL_SMS_Response response;	ATResponse *p_response = NULL;	smsc = ((const char **)data)[0];	pdu = ((const char **)data)[1];	tpLayerLength = strlen(pdu)/2;	if (smsc == NULL) {		smsc= "00";	}	asprintf(&cmd1, "AT+CMGS=%d", tpLayerLength);	asprintf(&cmd2, "%s%s", smsc, pdu);		err = at_send_command_sms(cmd1, cmd2, "+CMGS:", &p_response);	free(cmd1);	free(cmd2);		if (err < 0 || p_response->success == 0) goto error;	memset(&response, 0, sizeof(response));	/* FIXME fill in messageRef and ackPDU */	/*BEGIN Added by QKF33988 2010-11-30 DTS2010112405154 SMS Statues Report*/	int mr = 0;	if(p_response->p_intermediates != NULL)	{		char *line = p_response->p_intermediates->line;		err = at_tok_start(&line);				if (err < 0) {			goto error;		}		err = at_tok_nextint(&line, &mr);		if (err < 0) {			goto error;		}	}	response.messageRef = mr;	response.ackPDU=NULL;	response.errorCode=0;	/*END Added by QKF33988 2010-11-30 DTS2010112405154*/	RIL_onRequestComplete(t, RIL_E_SUCCESS, &response, sizeof(response));	at_response_free(p_response);	return;	error:	RIL_onRequestComplete(t, RIL_E_GENERIC_FAILURE, NULL, 0);	at_response_free(p_response);	return;}	#if 0/* request functions **/void requestSendSMS_CDMA(void *data, size_t datalen, RIL_Token t){	int err;	const char *smsc;	const char *pdu;	int tpLayerLength;	char *cmd1, *cmd2;	RIL_SMS_Response response;	ATResponse *p_response = NULL;/*        try {            rr.mParcel.writeInt(dis.readInt()); //teleServiceId            rr.mParcel.writeByte((byte) dis.readInt()); //servicePresent            rr.mParcel.writeInt(dis.readInt()); //serviceCategory            rr.mParcel.writeInt(dis.read()); //address_digit_mode            rr.mParcel.writeInt(dis.read()); //address_nbr_mode            rr.mParcel.writeInt(dis.read()); //address_ton            rr.mParcel.writeInt(dis.read()); //address_nbr_plan            address_nbr_of_digits = (byte) dis.read();            rr.mParcel.writeByte((byte) address_nbr_of_digits);            for(int i=0; i < address_nbr_of_digits; i++){                rr.mParcel.writeByte(dis.readByte()); // address_orig_bytes[i]            }            rr.mParcel.writeInt(dis.read()); //subaddressType            rr.mParcel.writeByte((byte) dis.read()); //subaddr_odd            subaddr_nbr_of_digits = (byte) dis.read();            rr.mParcel.writeByte((byte) subaddr_nbr_of_digits);            for(int i=0; i < subaddr_nbr_of_digits; i++){                rr.mParcel.writeByte(dis.readByte()); //subaddr_orig_bytes[i]            }            bearerDataLength = dis.read();            rr.mParcel.writeInt(bearerDataLength);            for(int i=0; i < bearerDataLength; i++){                rr.mParcel.writeByte(dis.readByte()); //bearerData[i]            }*/    RIL_CDMA_SMS_Message * p_CDMA_SMS_Message = (RIL_CDMA_SMS_Message *)data;    ALOGD("requestSendSMS_CDMA 1:%s",p_CDMA_SMS_Message->sAddress.digits);    ALOGD("requestSendSMS_CDMA 2:%s",p_CDMA_SMS_Message->aBearerData);    //	smsc = ((const char **)data)[0];//	pdu = ((const char **)data)[1];////	tpLayerLength = strlen(pdu)/2;	if (smsc == NULL) {		smsc= "00";	}	asprintf(&cmd1, "AT^HCMGS=\"%s\"", p_CDMA_SMS_Message->sAddress.digits);	asprintf(&cmd2, "%s", p_CDMA_SMS_Message->aBearerData);		err = at_send_command_sms(cmd1, cmd2, "^HCMGS:", &p_response);	free(cmd1);	free(cmd2);		if (err < 0 || p_response->success == 0) goto error;	memset(&response, 0, sizeof(response));	/* FIXME fill in messageRef and ackPDU */	/*BEGIN Added by QKF33988 2010-11-30 DTS2010112405154 SMS Statues Report*/	int mr = 0;	if(p_response->p_intermediates != NULL)	{		char *line = p_response->p_intermediates->line;		err = at_tok_start(&line);				if (err < 0) {			goto error;		}		err = at_tok_nextint(&line, &mr);		if (err < 0) {			goto error;		}	}	response.messageRef = mr;	response.ackPDU=NULL;	response.errorCode=0;	/*END Added by QKF33988 2010-11-30 DTS2010112405154*/	RIL_onRequestComplete(t, RIL_E_SUCCESS, &response, sizeof(response));	at_response_free(p_response);	return;	error:	RIL_onRequestComplete(t, RIL_E_GENERIC_FAILURE, NULL, 0);	at_response_free(p_response);	return;}#else typedef struct {    int imPos;    char pdu[1024];}Cdma_Pdu;/************************************************ Function:  encodepdu Description:      将上层传下来的RIL_CDMA_SMS_Message结构体拆离    并组成PDU包 Calls:  Called By: request_write_sms_to_ruim                    request_send_cdma_sms Input:   data-上层传下来的RIL_CDMA_SMS_Message结构体指针   dest-组成的PDU包转成字符串后存放的地址   Args-RIL_CDMA_SMS_WriteArgs结构体指针            为兼容将CDMA短信写到RUIM卡中增加的参数 Output:    none Return:    none Others:    lkf333986 2011-04-19**************************************************/void encodepdu(void *data, char *dest ,RIL_CDMA_SMS_WriteArgs *Args){        RIL_CDMA_SMS_Message *message;        Cdma_Pdu cpdu;        int iAddParLenb = 0;        int i = 0;//修改pclint警告 KF36756 2011-04-21        //char c;        memset(&cpdu,0,sizeof(Cdma_Pdu));        message = (RIL_CDMA_SMS_Message *)data;        writebits(&cpdu, 8, 0);//message type        writebits(&cpdu, 8, 0);//Teleservice identifer type        writebits(&cpdu, 8, 2);//Teleservice identifer parameter lengh        //Teleservice identifer        ALOGD("message->uTeleserviceID-----%04x",message->uTeleserviceID);        writebits(&cpdu, 8, message->uTeleserviceID >> 8);        writebits(&cpdu, 8, message->uTeleserviceID);        //destination address type        if ((Args != NULL) && (Args->status == 0 ||Args->status ==1))        {                writebits(&cpdu, 8,2);        }        else        {                writebits(&cpdu, 8,4);        }        if(message->sAddress.digit_mode == RIL_CDMA_SMS_DIGIT_MODE_4_BIT)        {                //if(RIL_DEBUG) LOGD("sAddress.number_of_digits---%d",message->sAddress.number_of_digits);                iAddParLenb = 10 + message->sAddress.number_of_digits *4;                //if(RIL_DEBUG) LOGD("iAddParLenb---%d--%d--%d",iAddParLenb,(iAddParLenb/8 + (iAddParLenb % 8)? 1:0),(iAddParLenb/8 + ((iAddParLenb % 8)? 1:0)));                writebits(&cpdu, 8,(iAddParLenb/8 + ((iAddParLenb % 8)? 1:0))); //destination address parameter lengh                writebits(&cpdu,2,0);                writebits(&cpdu,8,message->sAddress.number_of_digits);                for (i = 0; i < message->sAddress.number_of_digits ; i++)                {                        writebits(&cpdu, 4, message->sAddress.digits[i]);                }                writebits(&cpdu, (iAddParLenb % 8) ? (8-iAddParLenb % 8) : 0, 0);        }        else if (message->sAddress.digit_mode == RIL_CDMA_SMS_DIGIT_MODE_8_BIT)        {                //if(RIL_DEBUG) LOGD("sAddress.number_of_digits---%d",message->sAddress.number_of_digits);                iAddParLenb = 10 + message->sAddress.number_of_digits *8;                //if(RIL_DEBUG) LOGD("iAddParLenb---%d--%d--%d",iAddParLenb,(iAddParLenb/8 + (iAddParLenb % 8)? 1:0),(iAddParLenb/8 + ((iAddParLenb % 8)? 1:0)));                writebits(&cpdu, 8,(iAddParLenb/8 + ((iAddParLenb % 8)? 1:0))); //destination address parameter lengh                writebits(&cpdu,2,2);                writebits(&cpdu,8,message->sAddress.number_of_digits);                for (i = 0; i < message->sAddress.number_of_digits ; i++)                {                        writebits(&cpdu, 8, message->sAddress.digits[i]);                }                writebits(&cpdu, (iAddParLenb % 8) ? (8-iAddParLenb % 8) : 0, 0);        }        //user data        writebits(&cpdu, 8, 8);          writebits(&cpdu, 8, message->uBearerDataLen);        ALOGD("message->uBearerDataLen-----%04x",message->uBearerDataLen);        for (i = 0; i < message->uBearerDataLen; i++)        {                writebits(&cpdu,8,message->aBearerData[i]);        }        for ( i = 0; i < (cpdu.imPos >> 3); i++)//修改pclint警告 KF36756 2011-04-21        {                sprintf(dest+i*2,"%02X",cpdu.pdu[i]);        }}/************************************************ Function:  writebits Description:      向一指定内存按位写入数据 Calls:  Called By: encodepdu Input:    pd-Cdma_Pdu结构体指针，将数据写到结构体成员pdu中    bits-要写的位数    data-要写入的数据 Output:    none Return:    none Others:    lkf333986 2011-04-19**************************************************/void writebits(Cdma_Pdu *pd, int bits, int data){           int inde = 0;//修改pclint警告 KF36756 2011-04-21        int offset = 0;         if ((bits < 0) ||(bits > 8))            return;        data &= ((~0) >> (32 - bits));        inde = pd->imPos >> 3;        offset = 16 - (pd->imPos  & 0x07) - bits;          data <<= offset;        pd->imPos  += bits;        pd->pdu[inde] |= data >> 8;        if (offset < 8) pd->pdu[inde + 1] |= data & 0xFF;          }/*END Added by kf33986 2011-4-19 CDMA SMS*//************************************************ Function:  request_send_cdma_sms Description:      发送CDMA短信 Calls:  Called By: hwril_request_sms Input:   data-RIL_CDMA_SMS_WriteArgs结构体指针   datalen-参数长度   t-request标号 Output:    none Return:    none Others:    lkf333986 2011-04-19**************************************************/void request_send_cdma_sms(void * data, size_t datalen, RIL_Token t){        ALOGD("--------------requeset_send_cdma_sms-------");        int err;        char *cmd1;        //int type = -1;//修改pclint警告 KF36756 2011-04-21        //RIL_CDMA_SMS_Message *messag;        RIL_SMS_Response response;        ATResponse *p_response = NULL;        char pdudata[2048] = "";        encodepdu(data, pdudata,NULL);                asprintf(&cmd1, "AT^HCMGS=%d", strlen(pdudata)/2);        err =  at_send_command_sms(cmd1,pdudata,"^HCMGS:",&p_response);        //if(RIL_DEBUG) LOGD("pdudata: %s",pdudata);        free(cmd1);        if (err < 0 || p_response->success == 0) goto error;	memset(&response, 0, sizeof(response));	int mr = 0;	if(p_response->p_intermediates != NULL)	{		char *line = p_response->p_intermediates->line;        ALOGD("p_intermediates->line :%s",line);		err = at_tok_start(&line);				if (err < 0) {			goto error;		}		err = at_tok_nextint(&line, &mr);		if (err < 0) {			goto error;		}	}	response.messageRef = mr;	response.ackPDU=NULL;	response.errorCode=0;	RIL_onRequestComplete(t, RIL_E_SUCCESS, &response, sizeof(response));	at_response_free(p_response);		return;error:    ALOGD("error");	RIL_onRequestComplete(t, RIL_E_GENERIC_FAILURE, NULL, 0);	at_response_free(p_response);	return;}#endifvoid requestSMSAcknowledge(void *data, size_t datalen, RIL_Token t)	{      /* modified by zte-yuyang begin  we always think the sms received correct */  /*   int ackSuccess;   	int err;	   	ackSuccess = ((int *)data)[0];		    if (ackSuccess == 1)   	{        err = at_send_command("AT+CNMA=1", NULL);    }  	else if (ackSuccess == 0)    		{        err = at_send_command("AT+CNMA=2", NULL);    } 		else    			{        AALOGD("unsupported arg to RIL_REQUEST_SMS_ACKNOWLEDGE\n");        //goto error;			RIL_onRequestComplete(t, RIL_E_GENERIC_FAILURE, NULL, 0);				return;    }    */	   /* modified by zte-yuyang end*/   			RIL_onRequestComplete(t, RIL_E_SUCCESS, NULL, 0);		/*error:    RIL_onRequestComplete(t, RIL_E_GENERIC_FAILURE, NULL, 0);*/	}			void requestWriteSmsToSim(void *data, size_t datalen, RIL_Token t)			{    RIL_SMS_WriteArgs *p_args; 			char *cmd;    			int length;   			int err;			ATResponse *p_response = NULL;				    p_args = (RIL_SMS_WriteArgs *)data;	  			length = strlen(p_args->pdu)/2; 			asprintf(&cmd,"AT+CMGW=%d,%d", length, p_args->status);			           err = at_send_command_sms(cmd, p_args->pdu, "+CMGW:", &p_response);    if (err != 0 || p_response->success == 0) {			//goto error;		RIL_onRequestComplete(t, RIL_E_GENERIC_FAILURE, NULL, 0);	}		else	{		RIL_onRequestComplete(t, RIL_E_SUCCESS, NULL, 0);			}		at_response_free(p_response);	return;}void requestDeleteSmsOnSim(void *data, size_t datalen, RIL_Token t){	char * cmd;	ATResponse *p_response;	int err;	p_response = NULL;    asprintf(&cmd, "AT+CMGD=%d", ((int *)data)[0]);	err = at_send_command(cmd, &p_response);    free(cmd);	if (err < 0 || p_response->success == 0)    {		RIL_onRequestComplete(t, RIL_E_GENERIC_FAILURE, NULL, 0);	}    else	{		RIL_onRequestComplete(t, RIL_E_SUCCESS, NULL, 0);	}    at_response_free(p_response);	}// The follow functions are used to implement the  RIL_REQUEST_GSM_GET_BROADCAST_SMS_CONFIG requestint numbercaculatebycomma(char *pdata){	int count = 0;	while(*pdata)	{	    if((*pdata == ',')&&(*(pdata+1) != '\0'))			count++;		pdata++;	}	count++;		return count;}/***the ZTE_nextTok is like nextTok in the at_tok.c*it is for handling string**/static void ZTE_skipWhiteSpace(char **p_cur){    if (*p_cur == NULL) return;    while (**p_cur != '\0' && isspace(**p_cur)) {        (*p_cur)++;    }}static void ZTE_skipNextComma(char **p_cur){    if (*p_cur == NULL) return;    while (**p_cur != '\0' && **p_cur != ',') {        (*p_cur)++;    }    if (**p_cur == ',') {        (*p_cur)++;    }}static char * ZTE_nextTok(char **p_cur){    char *ret = NULL;    ZTE_skipWhiteSpace(p_cur);    if (*p_cur == NULL) {        ret = NULL;    } else if (**p_cur == '"') {        (*p_cur)++;        ret = strsep(p_cur, "\"");        ZTE_skipNextComma(p_cur);    } else {        ret = strsep(p_cur, ",");    }    return ret;}void makeBSC(RIL_GSM_BroadcastSmsConfigInfo *BSC,int num,char *mids,char *dcss,int mids_num,int dcss_num,int select){	int i;	int from = 0;	int to = 0;	char *ret;	char *end;	char *str_from;	for(i=0;i<num;i++)	{	    BSC[i].selected = select^0x01;	}		i=0;	while(mids != NULL)	{		if(*mids == '\0')		    break;	    ret = ZTE_nextTok(&mids);		str_from = strsep(&ret,"-");		if(ret == NULL)		{			BSC[i].fromServiceId = strtol(str_from,&end,10);			BSC[i].toServiceId =  BSC[i].fromServiceId;			i++;		}		else		{						BSC[i].fromServiceId = strtol(str_from,&end,10);			BSC[i].toServiceId =  strtol(ret,&end,10);			i++;		}			}		i=0;	while(dcss != NULL)	{		if(*dcss == '\0')		    break;	    ret = ZTE_nextTok(&dcss);		str_from = strsep(&ret,"-");		if(ret == NULL)		{			BSC[i].fromCodeScheme = strtol(str_from,&end,10);			BSC[i].toCodeScheme =  BSC[i].fromCodeScheme;			i++;		}		else		{						BSC[i].fromCodeScheme = strtol(str_from,&end,10);			BSC[i].toCodeScheme =  strtol(ret,&end,10);			i++;		}			}	}void requestGsmGetBroadcastSMSConfig(void *data, size_t datalen, RIL_Token t){	int err;	char *line;	int select;	char *mids;	int mids_num = 0;	char *dcss;	int dcss_num = 0;	int num;	int i;	RIL_GSM_BroadcastSmsConfigInfo **response;	RIL_GSM_BroadcastSmsConfigInfo *BSC;	ATResponse *p_response;		err=at_send_command_singleline("AT+CSCB?","+CSCB:",&p_response);	if(err < 0 || p_response->success == 0)	    RIL_onRequestComplete(t, RIL_E_GENERIC_FAILURE, NULL, 0);	else	{	    line = p_response->p_intermediates->line;		err=at_tok_start(&line);                   // skip the +CSCB:		if(err<0)		{			at_response_free(p_response);			RIL_onRequestComplete(t, RIL_E_GENERIC_FAILURE, NULL, 0);			return;		}		err=at_tok_nextint(&line,&select);		if(err<0)		{			at_response_free(p_response);			RIL_onRequestComplete(t, RIL_E_GENERIC_FAILURE, NULL, 0);			return;		}		err=at_tok_nextstr(&line,&mids);		if(err<0)		{			at_response_free(p_response);			RIL_onRequestComplete(t, RIL_E_GENERIC_FAILURE, NULL, 0);			return;		}		err=at_tok_nextstr(&line,&dcss);		if(err<0)		{			at_response_free(p_response);			RIL_onRequestComplete(t, RIL_E_GENERIC_FAILURE, NULL, 0);			return;		}		mids_num = numbercaculatebycomma(mids);		dcss_num = numbercaculatebycomma(dcss);		num = (mids_num > dcss_num)?mids_num:dcss_num;		BSC = (RIL_GSM_BroadcastSmsConfigInfo *)malloc(num*sizeof(RIL_GSM_BroadcastSmsConfigInfo));		response = (RIL_GSM_BroadcastSmsConfigInfo **)malloc(num*sizeof(RIL_GSM_BroadcastSmsConfigInfo*));		memset(BSC,-1,num*sizeof(RIL_GSM_BroadcastSmsConfigInfo));				for(i=0;i<num;i++)			response[i] = &BSC[i];				makeBSC(BSC,num,mids,dcss,mids_num,dcss_num,select);				RIL_onRequestComplete(t, RIL_E_SUCCESS, response, num*sizeof(RIL_GSM_BroadcastSmsConfigInfo *));		free(BSC);		free(response);	}	at_response_free(p_response);}// RIL_REQUEST_GSM_SET_BROADCAST_SMS_CONFIG request functionchar* substrsep(char **srcstr,char *substr){	char *ret = *srcstr;	int loc = 0;		if(strlen(*srcstr) < strlen(substr))	{		*srcstr = NULL;		return ret;	}		if(strstr(*srcstr,substr) == NULL)	{		*srcstr = NULL;		return ret;	}		*srcstr = strstr(*srcstr,substr);	loc = strlen(ret)-strlen(*srcstr);	*srcstr = *srcstr + (strlen(substr));		*(ret+loc) = '\0';		return ret;}void removefromstr(char *substr, char *oldstr, char **newstr){	char *ret;	int len = 0;		ret = substrsep(&oldstr,substr);	asprintf(newstr,"%s",ret);	while(oldstr != NULL)    // find substr in oldstr	{		if(*oldstr == ',')			oldstr++;		asprintf(newstr,"%s%s",*newstr,oldstr);		ret = substrsep(&oldstr,substr);	}}void addtostr(char *substr, char *oldstr, char **newstr){	removefromstr(substr,oldstr,newstr);	asprintf(newstr,"%s%s",*newstr,substr);}int createnewMIDSS(void *data, size_t datalen, char **oldmidsstr, char **newmidsstr){	RIL_GSM_BroadcastSmsConfigInfo **gsmBciPtrs = (RIL_GSM_BroadcastSmsConfigInfo **)data;	int num = datalen/sizeof(RIL_GSM_BroadcastSmsConfigInfo *);    char *sub_mid_str;	int len;	int i;		for(i=0;i<num;i++)    // for services ids	{	    if((gsmBciPtrs[i]->fromServiceId) != (gsmBciPtrs[i]->toServiceId))		    asprintf(&sub_mid_str,"%d-%d,",gsmBciPtrs[i]->fromServiceId,gsmBciPtrs[i]->toServiceId);		else			asprintf(&sub_mid_str,"%d,",gsmBciPtrs[i]->fromServiceId);				if(1 == gsmBciPtrs[i]->selected)		    addtostr(sub_mid_str,*oldmidsstr,newmidsstr);		else if (0 == gsmBciPtrs[i]->selected)			removefromstr(sub_mid_str,*oldmidsstr,newmidsstr);		*oldmidsstr = *newmidsstr;	}	if(**newmidsstr == '\0')	{		return -1;	}	len = strlen(*newmidsstr);	if(*(*newmidsstr+len-1) == ',')		*(*newmidsstr+len-1) = '\0';		return 0;}void createnewDICSS(void *data, size_t datalen, char **olddcssstr, char **newdcssstr){	RIL_GSM_BroadcastSmsConfigInfo **gsmBciPtrs = (RIL_GSM_BroadcastSmsConfigInfo **)data;	int num = datalen/sizeof(RIL_GSM_BroadcastSmsConfigInfo *);	char *sub_dcs_str;	int len;	int i;	for(i=0;i<num;i++)    //for CodeScheme configration	{	    if((gsmBciPtrs[i]->fromCodeScheme) != (gsmBciPtrs[i]->toCodeScheme))		    asprintf(&sub_dcs_str,"%d-%d,",gsmBciPtrs[i]->fromCodeScheme,gsmBciPtrs[i]->toCodeScheme);		else			asprintf(&sub_dcs_str,"%d,",gsmBciPtrs[i]->fromCodeScheme);				if(1 == gsmBciPtrs[i]->selected)		    addtostr(sub_dcs_str,*olddcssstr,newdcssstr);		else if (0 == gsmBciPtrs[i]->selected)			removefromstr(sub_dcs_str,*olddcssstr,newdcssstr);		*olddcssstr = *newdcssstr;	}	len = strlen(*newdcssstr);	if(*(*newdcssstr+len-1) == ',')		*(*newdcssstr+len-1) = '\0';	}void requestGsmSetBroadcastSMSConfig(void *data, size_t datalen, RIL_Token t){	int err;	char *cmd;	char *line;	ATResponse *p_response;	int select = -1;	char *oldmidsstr,*newmidsstr;	char *olddcssstr,*newdcssstr;	err=at_send_command_singleline("AT+CSCB?","+CSCB:",&p_response);	line = p_response->p_intermediates->line;	err=at_tok_start(&line);                   // skip the +CSCB:	err=at_tok_nextint(&line,&select);	err=at_tok_nextstr(&line,&oldmidsstr);	err=at_tok_nextstr(&line,&olddcssstr);	if(*oldmidsstr != '\0')	    asprintf(&oldmidsstr,"%s,",oldmidsstr);	if(*olddcssstr != '\0')	    asprintf(&olddcssstr,"%s,",olddcssstr);		err=createnewMIDSS(data, datalen, &oldmidsstr, &newmidsstr);	if(err == -1)	{		RIL_onRequestComplete(t, RIL_E_GENERIC_FAILURE, NULL, 0);		at_response_free(p_response);		return;	}	createnewDICSS(data, datalen, &olddcssstr, &newdcssstr);	asprintf(&cmd,"AT+CSCB=0,\"%s\",\"%s\"",newmidsstr,newdcssstr);	at_response_free(p_response);	err = at_send_command("AT+CSCB=1", &p_response);	if(err < 0 || p_response->success == 0)	{		RIL_onRequestComplete(t, RIL_E_GENERIC_FAILURE, NULL, 0);		at_response_free(p_response);		return;	}	at_response_free(p_response);	err = at_send_command(cmd, &p_response);	if(err < 0 || p_response->success == 0)	    RIL_onRequestComplete(t, RIL_E_GENERIC_FAILURE, NULL, 0);	else	    RIL_onRequestComplete(t, RIL_E_SUCCESS, NULL, 0);	at_response_free(p_response);	}// RIL_REQUEST_GSM_SMS_BROADCAST_ACTIVATIONvoid requestGsmSMSBroadcastActivation(void *data, size_t datalen, RIL_Token t){	int activate_flag = ((int *)data)[0];	int err;	char *cmd;	ATResponse *p_response;		if(0 == activate_flag)		asprintf(&cmd,"AT+CNMI=,,2,,");	else if (1 == activate_flag)		asprintf(&cmd,"AT+CNMI=,,0,,");	else	{		RIL_onRequestComplete(t, RIL_E_GENERIC_FAILURE, NULL, 0);	    return;	}		err = at_send_command(cmd, &p_response);	if(err < 0 || p_response->success == 0)	    RIL_onRequestComplete(t, RIL_E_GENERIC_FAILURE, NULL, 0);	else	    RIL_onRequestComplete(t, RIL_E_SUCCESS, NULL, 0);		at_response_free(p_response);}void requestGetSMSCAddress(void *data, size_t datalen, RIL_Token t){	int err;	ATResponse *p_response = NULL;	char *line;	char response[22];	err=at_send_command_singleline("AT+CSCA?","+CSCA:",&p_response);		if(err < 0 || p_response->success == 0)	{	    RIL_onRequestComplete(t, RIL_E_GENERIC_FAILURE, NULL, 0);	}	else	{	    line = p_response->p_intermediates->line;		err=at_tok_start(&line);                   // skip the +CSCA:		if(err<0)		{			at_response_free(p_response);			RIL_onRequestComplete(t, RIL_E_GENERIC_FAILURE, NULL, 0);			return;		}		err=at_tok_nextstr(&line,&response);       // get the sms center string		if(err<0)		{			at_response_free(p_response);			RIL_onRequestComplete(t, RIL_E_GENERIC_FAILURE, NULL, 0);			return;		}		RIL_onRequestComplete(t, RIL_E_SUCCESS, &response, sizeof(response));	}	at_response_free(p_response);}void requestSetSMSCAddress(void *data, size_t datalen, RIL_Token t){	char *center_num = (char *)data;	char *cmd;	int err;	ATResponse *p_response;		if(center_num[0] == '+')		asprintf(&cmd,"AT+CSCA=%s,145",center_num);    // international number	else		asprintf(&cmd,"AT+CSCA=%s,161",center_num);		err=at_send_command(cmd, &p_response);		if(err < 0 || p_response->success == 0)		RIL_onRequestComplete(t, RIL_E_GENERIC_FAILURE, NULL, 0);	else		RIL_onRequestComplete(t, RIL_E_SUCCESS, NULL, 0);		at_response_free(p_response);}void requestReportSMSMemoryStatus(void *data, size_t datalen, RIL_Token t){    int memory_availble = ((int *)data)[0];	int err; 	char *cmd;	ATResponse *p_response;		if(1 == memory_availble)		sprintf(&cmd,"AT+CNMI=3,1");	else if (0 == memory_availble)		sprintf(&cmd,"AT+CNMI=0,0");	else	{		RIL_onRequestComplete(t, RIL_E_GENERIC_FAILURE, NULL, 0);	    return;	}	err = at_send_command(cmd, &p_response);	if(err < 0 || p_response->success == 0)	    RIL_onRequestComplete(t, RIL_E_GENERIC_FAILURE, NULL, 0);	else	    RIL_onRequestComplete(t, RIL_E_SUCCESS, NULL, 0);	at_response_free(p_response);}/*  functions called when AT command comes up   * */void onNewSmsNotification(char *s){	//add by zte-tony	/* can't issue AT commands here -- call on main thread */	ALOGD("********enter onNewSmsNotification********");		int location;	char *response = NULL;	char *tmp;	char *line = NULL;	int err;		if(strStartsWith(s, "+CMTI:") )	{	    sms_type = SMS_GENERAL;	} 	else if ( strStartsWith(s, "+CDSI:"))	{	    sms_type = SMS_SEND_REPORT;	    	 	}	else if(strStartsWith(s, "+CBMI:"))	{	   sms_type = SMS_BROADCAST;	}	line = strdup(s);	tmp = line;	at_tok_start(&tmp);		err = at_tok_nextstr(&tmp, &response);	if (err < 0)	{		ALOGD("sms request fail");		free(line);		return;	}		/*  modified by zte-yuang for support new SMS at SIM begin */	/*	if (!strcmp(response, "SM"))	{		ALOGD("sms request arrive but it is not a new sms");		free(line);		return;	}	*/		/*  modified by zte-yuang for support new SMS at SIM end */	/* Read the memory location of the sms */	err = at_tok_nextint(&tmp, &location);	if (err < 0)	{		ALOGD("error parse location");		free(line);		return;	}		/*		asprintf(&cmd, "AT+CPMS=%s,%s,%s", "ME","ME","ME");		//at_send_command("AT+CPMS=\"ME\",\"ME\",\"ME\"", NULL);		at_send_command(cmd, NULL);		free(cmd);				if (!strcmp(response, "SR"))			{			    NEW_SMS_TYPE = 			   //err=at_send_command("AT+CPMS=\"SR\",\"SR\",\"SR\"", NULL);			   asprintf(&cmd, "AT+CPMS=%s,%s,%s", "SR","SR","SR");			   err = at_send_command(cmd, NULL);			   free(cmd);			    	if (err < 0)	   {	     	ALOGD("******** set cpms failed,so we lost sms report ********");	     	 ALOGD("******** err=%d",err);		     return;			}		}	*/	ALOGD("********LEAVE onNewSmsNotification********");	RIL_requestTimedCallback (receiveSMS, (void *)location, NULL);	free(line);  }void receiveSMS(void *param){    int location = (int)param;    char *cmd;    int err;    ATLine *p_cur = NULL;	char  *line;	int state;	int reserved;	int length;	char *pdu;    	char atcmd[50] = {0}; 	ATResponse *p_response = NULL;		/*added by yuyang begin for SMS_SEND_REPORT and broadcast begin */	if (sms_type == SMS_GENERAL)	{//    at_send_command("AT+CPMS=\"ME\",\"ME\",\"ME\"", NULL);	    at_send_command("AT+CPMS=\"SM\",\"SM\",\"SM\"", NULL);		}	else if (sms_type == SMS_SEND_REPORT)	{	    at_send_command("AT+CPMS=\"SR\",\"SR\",\"SR\"", NULL);	}	else if (sms_type == SMS_BROADCAST)	{	    at_send_command("AT+CPMS=\"ME\",\"ME\",\"ME\"", NULL);		}	/*added by yuyang begin for SMS_SEND_REPORT and broadcast end */	//    if (screenStatus) {    asprintf(&cmd, "AT+CMGR=%d", location);    /* request the sms in a specific location */    //at_send_command(ATch_primary, cmd, NULL);#if 0        at_send_command(cmd, NULL);    free(cmd);    /* remove the sms from specific location XXX temp fix*/    asprintf(&cmd, "AT+CMGD=%d,0", location);    at_send_command(cmd, NULL);	//at_send_command(ATch_primary, cmd, NULL);    free(cmd);	//    } else	//            RIL_requestTimedCallback (receiveSMS, param, &TIMEVAL_SIMPOLL);#else    err = at_send_command_multiline(cmd, "+CMGR:", &p_response);/*BEGIN DTS2013091610549 w84014221 2013-09-21 added*/    if( NULL == p_response )	{		ALOGD("read_sms_on_sim_and_unsol_response:+CMGR:p_response is NULL!");	}/*END DTS2013091610549 w84014221 2013-09-21 added*/	 	if (err < 0 || p_response->success == 0)	{		return -1;	}	p_cur = p_response->p_intermediates;	if(p_cur == NULL)	{		at_response_free(p_response);		return -1;	}	line = p_cur->line;	ALOGD("line1 : %s",line);		err = at_tok_start(&line);	ALOGD("line1,err : %d",err);	if (err < 0) goto delete;			err = at_tok_nextint(&line, &state);	ALOGD("line1,err : %d,state:",err,state);	if (err < 0 ) goto delete;		err = at_tok_nextint(&line, &reserved);	err = at_tok_nextint(&line, &length);	ALOGD("line1,err : %d,length:%d",err,length);	if (err < 0) goto delete;		p_cur = p_cur->p_next;	if(NULL==p_cur)  {	    ALOGD("line2 ,p_cur ==NULL");	    goto delete;	}	line = p_cur->line;	ALOGD("line2 : %s",line);	err = at_tok_nextstr(&line, &pdu);	if (err < 0) goto delete;	/* BEGIN DTS2011120206709 kf32792 20111205 deleted */	/*	if(0 ==strcmp(pre_pdu,pdu))	{		goto delete;	}		strcpy(pre_pdu,pdu);	*/    /* END DTS2011120206709 kf32792 20111205 deleted */    //	if(NETWORK_CDMA==g_module_type)//	{//		RecievePduSms(pdu,mode);//	}//	else//	{//		if(CMD_CMTI== mode)//		{			ALOGD("___________There has a new message ______________");			RIL_onUnsolicitedResponse (RIL_UNSOL_RESPONSE_NEW_SMS, pdu, length);//		}//		else//		{//			RIL_onUnsolicitedResponse (RIL_UNSOL_RESPONSE_NEW_SMS_STATUS_REPORT, pdu, length);//		}//	}	delete:	//delete sms from SIM	/*BEGIN DTS2013091610549 w84014221 2013-09-21 modified*/	if (NULL != p_response)	{	    at_response_free(p_response);	}        asprintf(&cmd, "AT+CMGD=%d,0", location);	/*END DTS2013091610549 w84014221 2013-09-21 modified*/	err = at_send_command(cmd, NULL);	return 1;	//Unsolicited the new sm        #endif	at_send_command("AT+CPMS=\"ME\",\"ME\",\"ME\"", NULL);	    return;}